<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.unknown100name.ecommerce.dao.ItemMapper">

    <sql id="itemBaseDTOProperty">
        id, title, sub_title, state, sell_count, image_base64
    </sql>

    <sql id="itemDetailDTOProperty">
        id, title, sub_title, h5_base64, state, sell_count, image_base64
    </sql>
    
    <sql id="innerItemDTOProperty">
        id, type_name, price, image_base64, iventory
    </sql>

    <resultMap id="itemBaseDTO" type="org.unknown100name.ecommerce.pojo.dto.ItemBaseDTO">
        <id column="id" property="id" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="title" property="title" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="sub_title" property="subTitle" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="state" property="state" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="sell_count" property="sellCount" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="image_base64" property="mainImageBase64" javaType="java.lang.String" jdbcType="VARCHAR"/>

        <association property="shop" javaType="org.unknown100name.ecommerce.pojo.dto.UserBaseDTO" select="org.unknown100name.ecommerce.dao.UserMapper.getUserById" column="shop_id"/>
    </resultMap>

    <resultMap id="itemDetailDTO" type="org.unknown100name.ecommerce.pojo.dto.ItemDetailDTO">
        <id column="id" property="id" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="title" property="title" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="sub_title" property="subTitle" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="h5_base64" property="h5Base64" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="state" property="state" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="sell_count" property="sellCount" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="image_base64" property="mainImageBase64" javaType="java.lang.String" jdbcType="VARCHAR"/>

        <association property="shop" javaType="org.unknown100name.ecommerce.pojo.dto.UserBaseDTO" select="org.unknown100name.ecommerce.dao.UserMapper.getUserById" column="shopId"/>

        <collection property="imageListBase64" javaType="java.lang.String" select="org.unknown100name.ecommerce.dao.ItemImageMapper.getItemImagesByItemId" column="id"/>
        <collection property="innerItemList" javaType="org.unknown100name.ecommerce.pojo.dto.InnerItemDTO" select="org.unknown100name.ecommerce.dao.ItemMapper.getInnerItemByItemId" column="id"/>
        <collection property="evaluateList" javaType="org.unknown100name.ecommerce.pojo.dto.EvaluateDTO" select="org.unknown100name.ecommerce.dao.EvaluateMapper.getEvaluateByItemId" column="id"/>
    </resultMap>
    
    <resultMap id="innerItemDTO" type="org.unknown100name.ecommerce.pojo.dto.InnerItemDTO">
        <id column="id" property="id" javaType="java.lang.Long" jdbcType="INTEGER"/>
        <result column="type_name" property="typeName" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="price" property="price" javaType="java.math.BigDecimal" jdbcType="DECIMAL"/>
        <result column="image_base64" property="imageBase64" javaType="java.lang.String" jdbcType="VARCHAR"/>
        <result column="inventory" property="inventory" javaType="java.lang.Integer" jdbcType="INTEGER"/>
    </resultMap>

    <!-- ITEM -->

    <select id="getItemBaseByKeyword" resultType="org.unknown100name.ecommerce.pojo.dto.ItemBaseDTO">
        SELECT <include refid="itemBaseDTOProperty"/>
        FROM item i LEFT JOIN item_image ii ON i.id = ii.item_id AND ii.type = 1
        WHERE (i.title LIKE CONCAT('%',#{keyword},'%') OR i.sub_title LIKE CONCAT('%',#{keyword},'%'))
    </select>

    <select id="getItemBaseByShopId" resultType="org.unknown100name.ecommerce.pojo.dto.ItemBaseDTO">
        SELECT <include refid="itemBaseDTOProperty"/>
        FROM item i LEFT JOIN item_image ii on i.id = ii.item_id AND ii.type = 1
        WHERE i.shop_id = #{shopId}
    </select>

    <select id="getItemBaseById" resultType="org.unknown100name.ecommerce.pojo.dto.ItemBaseDTO">
        SELECT <include refid="itemBaseDTOProperty"/>
        FROM item i LEFT JOIN item_image ii on i.id = ii.item_id AND ii.type = 1
        AND i.id = #{itemId}
    </select>

    <select id="getItemDetailById" resultType="org.unknown100name.ecommerce.pojo.dto.ItemDetailDTO">
        SELECT <include refid="itemDetailDTOProperty"/>
        FROM item i LEFT JOIN item_image ii on i.id = ii.item_id AND ii.type = 1
        AND i.id = #{itemId}
    </select>

    <update id="updateItemState" parameterType="java.lang.Long">
        UPDATE item
        SET item.state = #{to}
        WHERE item.id = #{itemId} AND item.state = #{from}
    </update>

    <update id="increaseSell" parameterType="java.lang.Long">
        UPDATE item
        SET item.sell_count = item.sell_count + 1
        WHERE item.id = #{itemId}
    </update>

    <!-- INNERITEM -->

    <select id="getInnerItemByItemId" resultMap="innerItemDTO">
        SELECT <include refid="innerItemDTOProperty"/>
        FROM inner_item ii LEFT JOIN item_image iimage on iimage.item_id = ii.item_id AND iimage.type = 2
        WHERE ii.item_id = #{itemId}
    </select>

    <insert id="insertInnerItem" parameterType="java.util.List">
        INSERT INTO
        inner_item(id, item_id, type_name, price, inventory)
        VALUES
        <foreach collection="innerItemList" item="innerItem" index="index" separator=",">
            (#{innerItem.id}, #{innerItem.itemId}, #{innerItem.typeName}, #{innerItem.price}, #{innerItem.inventory},)
        </foreach>
    </insert>


</mapper>